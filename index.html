
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>solidity2</title>
<link rel="stylesheet" type="text/css" href="css.css">
<link rel="stylesheet" href="default.css" type="text/css" />
<link rel="stylesheet" href="contents.css" type="text/css" />
</head>
<body>
 
<h2>CryptChat</h2>

<input id="value_set" type="text" >
<a href="#" class="square_btn" onclick="set();return false;">書き込み</a>
<a href="#" class="square_btn" onclick="update();return false;">更新</a>
<br>
<br>

<p id="wallet_data"></p>

<!-- landmark -->
<table class="bordered">
    <thead>
    <tr>
        <th>#</th>
        <th>contents</th>
        <th>timestamp</th>
    </tr>
	</thead>
	<tbody id="tbody">
	</tbody>
</table>

<script src="./const.js"></script>
<script type="text/javascript">
// global start
if (typeof web3 !== 'undefined') {
	window.web3 = new Web3(web3.currentProvider);
} else {
	document.write("Please install metamask");
}
// コントラクト
var contract = web3.eth.contract(JSON.parse(ABI)).at(CONTRACT_ADDR);
//イベント監視
contract.Write().watch(function (error, result) {
	console.log('result : ');
	console.log(result);
	
	// イベントキャッチのタイミングで自動更新
	update();
});

// global end
// 更新(F5)
new Promise((resolve)=>{
	window.web3.eth.getAccounts((err, accounts) => {
		resolve(accounts);
	});
}).then((accounts)=>{
	update();
});

function update(){
	var s = "";
	var posts = [];
	var promises = [];

	new Promise((resolve)=>{
		contract.getPostsLength((e,r)=>{
			var len = r.toNumber();
			console.log("len : " + len);
			resolve(len);
		});
	}).then((len)=>{
		for(var i=0; i<len; i++){
			promises[i] = new Promise((resolve)=>{
				contract.getText(i, (e, r)=>{
					resolve(r);
				});
			});
		}
		console.log(promises.length);
		Promise.all(promises).then((values)=>{
			var id = 0;
			for(var t of values){
				s += "<tr>";
				s += "<td>";
				s += (id++);
				s += "</td>";
				s += "<td>";
				s += t;
				console.log("t : " + t);
				s += "</td>";
				s += "<td>";
				s += "--";
				s += "</td>";
				s += "</tr>";
			}
			var tbody = document.getElementById("tbody");
			tbody.innerHTML = s;
		});
	});
}

function set(){
	var value_set = document.getElementById("value_set").value;
	// ガード
	if(value_set === ""){
		alert("何か書いて");
		return;
	}
	// 書き込み
	contract.set(value_set, function(err, value){
		// console.log();
	});
}
 
</script>
</body>
</html>