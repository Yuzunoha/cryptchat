<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CryptChat</title>
<link rel="stylesheet" type="text/css" href="css.css">
<link rel="stylesheet" href="default.css" type="text/css" />
<link rel="stylesheet" href="contents.css" type="text/css" />
</head>
<body>
<h2>CryptChat(ropsten)</h2>

<input id="value_set" type="text" >
<a href="#" class="square_btn" onclick="set();return false;">書き込み</a>
<a href="#" class="square_btn" onclick="update();return false;">更新</a>
<br>
<br>

<p id="wallet_data"></p>

<table class="bordered">
    <thead>
    <tr>
        <th>#</th>
        <th>text</th>
        <th>address</th>
        <th>timestamp</th>
    </tr>
	</thead>
	<tbody id="tbody">
	</tbody>
</table>

<script src="./const.js"></script>
<script type="text/javascript">
// global start
if (typeof web3 !== 'undefined') {
	window.web3 = new Web3(web3.currentProvider);
} else {
	document.write("Please install metamask");
}
// コントラクト
var contract = web3.eth.contract(JSON.parse(ABI)).at(CONTRACT_ADDR);
//イベント監視
contract.Write().watch(function (error, result) {
	console.log('result : ');
	console.log(result);
	
	// イベントキャッチのタイミングで自動更新
	update();
});

// global end
// 更新(F5)
new Promise((resolve)=>{
	window.web3.eth.getAccounts((err, accounts) => {
		resolve(accounts);
	});
}).then((accounts)=>{
	update();
});

function update(){
	var s = "";
	var promises = [];
	var len;
	new Promise((resolve)=>{
		contract.getPostsLength((e,r)=>{
			len = r.toNumber();
			resolve(len);
		});
	}).then((len)=>{
		const getPromise = (i, attr) => {
			return new Promise((resolve) => {
				switch(attr){
				case "text":
					contract.getText(i, (e, r)=>{
						var key = 'text' + i;
						var value = r;
						resolve({[key]: value});
					});
					break;
				case "addr":
					contract.getAddr(i, (e, r)=>{
						var key = 'addr' + i;
						var value = r;
						resolve({[key]: value});
					});
					break;
				case "time":
					contract.getTime(i, (e, r)=>{
						var key = 'time' + i;
						var value = r.toString();
						resolve({[key]: value});
					});
					break;
				}
			});
		};
		for(var i=0; i<len; i++){
			promises.push(getPromise(i, "text"));
			promises.push(getPromise(i, "addr"));
			promises.push(getPromise(i, "time"));
		}
		Promise.all(promises).then((results)=>{
			var posts = [];
			for(var result of results){
				for(var key of Object.keys(result)){
					console.log("key : " + key);
					var value = result[key];
					posts[key] = value;
				}
			}
			for(var i=0; i<len; i++){
				s += "<tr>";
				s += "<td>";
				s += i;
				s += "</td>";
				s += "<td>";
				s += posts["text" + i];
				s += "</td>";
				s += "<td>";
				s += posts["addr" + i];
				s += "</td>";
				s += "<td>";
				s += posts["time" + i];
				s += "</td>";
				s += "</tr>";
			}
			var tbody = document.getElementById("tbody");
			tbody.innerHTML = s;
		});
	});
}

function set(){
	var value_set = document.getElementById("value_set").value;
	// ガード
	if(value_set === ""){
		alert("何か書いて");
		return;
	}
	// 書き込み
	contract.set(value_set, function(err, value){
		// console.log();
	});
}
 
</script>
</body>
</html>